<div class="cart-container mt-4">

  <!-- Carrito de productos -->
  <div class="flex-grow-1" style="width: 100%;">
    <div *ngFor="let item of cart" class="d-flex flex-wrap gap-2 border-bottom py-3 align-items-start">

      <!-- Imagen del producto -->
       <div>
      <img [src]="item.variant.image" alt="{{ item.name }}" class="cart-item-image img-fluid" />
    </div>

      <!-- InformaciÃ³n principal -->
      <div class="cart-item-info" style="max-width: 350px; flex-shrink: 0;">
        <h5 class="mb-1">{{ item.name }}</h5>
        <p class="text-muted mb-1">Marca: {{ getBrand(item.name) }}</p>
        <p class="mb-1">
          <strong>Color:</strong> {{ item.variant.color }}<br />
          <strong>Talla:</strong> {{ item.talla }}
        </p>
        <p class="text-success mb-1">Llega maÃ±ana</p>
        <p class="text-primary mb-1">Retira hoy</p>
        <p *ngIf="hasDiscount(item)" class="text-warning mb-1">Ãšltimas unidades</p>
      </div>

      <!-- Precio y cantidad -->
      <div class="cart-item-actions" style="width: 130px; flex-shrink: 0; gap: 6px;">
        
        <!-- Precio final (con cantidad) -->
        <span class="fw-bold fs-5 text-dark">
          S/ {{ (item.price * item.quantity) | number: '1.2-2' }}
        </span>

        <!-- Precio unitario si hay mÃ¡s de 1 -->
        <small class="text-muted" *ngIf="item.quantity > 1">
          (S/ {{ item.price | number: '1.2-2' }} c/u)
        </small>

        <!-- Descuento -->
        <span *ngIf="hasDiscount(item)" class="badge bg-danger" style="font-size: 0.8rem;">
          -{{ item.discountPercent }}%
        </span>

        <!-- Precio original tachado -->
        <span *ngIf="hasDiscount(item)" class="text-muted text-decoration-line-through" style="font-size: 0.85rem;">
          S/ {{ (getOriginalPrice(item) * item.quantity) | number: '1.2-2' }}
        </span>

        <!-- Controles de cantidad -->
        <div class="d-flex align-items-center gap-2">
          <button (click)="decreaseQuantity(item)" class="btn btn-sm btn-outline-secondary py-0 px-2">âˆ’</button>
          <span>{{ item.quantity }}</span>
          <button (click)="increaseQuantity(item)" class="btn btn-sm btn-outline-secondary py-0 px-2">+</button>
        </div>

        <small class="text-muted" style="font-size: 0.8rem;">MÃ¡x {{ getMaxStock(item) }} unidades</small>
      </div>

    </div>
  </div>

  <!-- ðŸ§¾ Resumen de compra -->
  <div class="purchase-summary p-3 border rounded shadow-sm" style="min-width: 280px; max-width: 400px; width: 100%;">
    <div class="mb-2">
      <strong>Productos ({{ cart.length }})</strong>
      <div>S/ {{ subtotal | number: '1.2-2' }}</div>
    </div>

    <!-- Descuentos -->
    <div *ngIf="discountTotal > 0" class="mb-2">
      <strong>Descuentos ({{ discountedItems.length }})</strong>
      <div class="text-danger">- S/ {{ discountTotal | number: '1.2-2' }}</div>

      <div *ngFor="let item of discountedItems" class="mt-2">
        <div class="fw-medium">{{ item.name }}</div>
        <div class="text-danger">
          - S/ {{ getItemDiscount(item) | number: '1.2-2' }}
        </div>
      </div>
    </div>

    <!-- Total -->
    <div class="mt-3">
      <strong>Total:</strong>
      <div class="text-success fw-bold">S/ {{ total | number: '1.2-2' }}</div>
    </div>

    <!-- EnvÃ­o gratis (simulado) -->
    <div *ngIf="total >= 5" class="text-success mt-2">
      Â¡EnvÃ­o gratis disponible!
    </div>

    <button class="btn btn-success w-100 mt-3" (click)="openCheckoutDialog()">
      Realizar compra
    </button>

  </div>
</div>




<p-dialog header="Datos de envÃ­o" [(visible)]="showCheckoutDialog" [modal]="true" [closable]="false" [style]="{width: '400px', 'max-width': '95vw'}">

  <form (ngSubmit)="confirmPurchase()" class="p-fluid">

    <div class="p-field">
      <label for="nombres">Nombres</label>
      <input id="nombres" pInputText type="text" [(ngModel)]="checkoutData.nombres" name="nombres" required />
    </div>

    <div class="p-field">
      <label for="apellidos">Apellidos</label>
      <input id="apellidos" pInputText type="text" [(ngModel)]="checkoutData.apellidos" name="apellidos" required />
    </div>

    <div class="p-field">
      <label for="departamento">Departamento</label>
      <input id="departamento" pInputText type="text" [(ngModel)]="checkoutData.departamento" name="departamento" required />
    </div>

    <div class="p-field">
      <label for="provincia">Provincia</label>
      <input id="provincia" pInputText type="text" [(ngModel)]="checkoutData.provincia" name="provincia" required />
    </div>

    <div class="p-field">
      <label for="distrito">Distrito</label>
      <input id="distrito" pInputText type="text" [(ngModel)]="checkoutData.distrito" name="distrito" required />
    </div>

    <div class="p-field">
      <label for="direccion">DirecciÃ²n</label>
      <input id="direccion" pInputText type="text" [(ngModel)]="checkoutData.direccion" name="direccion" required />
    </div>

    <div class="p-dialog-footer" style="display: flex; justify-content: flex-end; gap: 0.5rem;">
      <button pButton type="button" label="Cancelar" icon="pi pi-times" (click)="showCheckoutDialog = false" class="p-button-text"></button>
      <button pButton label="Enviar por WhatsApp" (click)="confirmPurchase()" type="button" class="mt-2 w-full"></button>
    </div>

  </form>

</p-dialog>


