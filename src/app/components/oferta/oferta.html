<div class="container my-4">
  <h1>Productos en oferta</h1>
  <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-4">
    <div *ngFor="let product of productsOnSale" class="col">
      <div class="card h-100 text-center shadow-sm position-relative">

        <!-- Badge porcentaje de descuento -->
        <div
          *ngIf="product.discountPercent"
          class="position-absolute top-0 start-0 bg-danger text-white px-2 py-1 rounded-bottom"
          style="z-index: 10; font-weight: bold; font-size: 0.9rem;"
        >
          -{{ product.discountPercent }}%
        </div>

        <div class="p-3">
          <img
            [src]="selectedVariant[product.id]?.image || product.variants[0].image"
            [alt]="product.name"
            class="img-fluid"
            style="max-height: 200px; object-fit: contain"
          />
        </div>

        <div class="card-body d-flex flex-column align-items-center">
          <h5 class="card-title">{{ product.name }}</h5>

          <p class="card-text fw-bold">
            <span class="text-muted text-decoration-line-through me-2" *ngIf="product.discountPercent">
              ${{ product.price.toFixed(2) }}
            </span>
            <span class="text-primary">
             ${{ getDiscountedPrice(product).toFixed(2) }}
            </span>
          </p>

          <div class="d-flex justify-content-center flex-wrap gap-2 mb-3">
            <span
              *ngFor="let variant of product.variants"
              class="rounded-circle border"
              [style.backgroundColor]="variant.hex"
              [class.border-dark]="
                selectedVariant[product.id]?.image === variant.image
              "
              (click)="selectVariant(product.id, variant)"
              style="width: 24px; height: 24px; cursor: pointer"
              title="{{ variant.hex }}"
            ></span>
          </div>

          <button
            class="btn btn-outline-primary w-100 mt-auto"
            (click)="openTallaDialog(product)"
          >
            Agregar al carrito
          </button>
        </div>
      </div>
    </div>
  </div>
</div>





<p-dialog
  [header]="confirmSuccess ? 'Confirmación' : 'Selecciona una talla'"
  [(visible)]="showTallaDialog"
  [modal]="true"
  [closable]="!confirmSuccess"
  [style]="{ width: '300px' }"
  [baseZIndex]="10000"
  (onHide)="resetDialog()"
>
  <div *ngIf="selectedProduct">

    <!-- MENSAJE EN LA PARTE SUPERIOR -->
    <p *ngIf="confirmSuccess" class="text-success fw-bold text-center mb-3">
      Producto agregado al carrito
    </p>

    <!--MOSTRAR TALLAS SOLO SI NO HA CONFIRMADO -->
    <div *ngIf="!confirmSuccess">
      <div class="d-flex flex-wrap gap-2 justify-content-center mb-3">
        <button
          *ngFor="let talla of selectedProduct.tallas"
          pButton
          type="button"
          [label]="talla"
          [class]="
            selectedTalla === talla
              ? 'p-button-sm p-button-primary'
              : 'p-button-sm p-button-outlined'
          "
          (click)="selectedTalla = talla"
        ></button>
      </div>

      <div class="text-end">
        <button
          pButton
          label="Confirmar"
          class="p-button-sm"
          [disabled]="!selectedTalla"
          (click)="confirmAddToCart()"
        ></button>
      </div>
    </div>

    <!--  OPCIONES DESPUÉS DE CONFIRMAR -->
    <div *ngIf="confirmSuccess" class="text-center">
      <div class="d-flex justify-content-around mt-4">
        <button
          pButton
          label="Seguir comprando"
          class="p-button-sm p-button-outlined"
          (click)="resetDialog()"
        ></button>

        <button
          pButton
          label="Ir al carrito"
          class="p-button-sm p-button-primary"
          routerLink="/cart"
          (click)="resetDialog()"
        ></button>
      </div>
    </div>
  </div>
</p-dialog>

